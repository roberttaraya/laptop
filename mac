#!/usr/bin/env bash
set -e

# --- Paths -----------------------------------------------------------

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BREWFILE_PATH="$SCRIPT_DIR/Brewfile"
VSCODE_REPO_DIR="$SCRIPT_DIR/vscode"
VSCODE_USER_DIR="$HOME/Library/Application Support/Code/User"

# --- Helper: Copy file only if missing -------------------------------

copy_if_missing() {
  local source="$1"
  local target="$2"

  if [ ! -f "$target" ]; then
    if [ -f "$source" ]; then
      echo "Copying $(basename "$source") to $target ..."
      mkdir -p "$(dirname "$target")"
      cp "$source" "$target"
    else
      echo "Source file not found: $source — skipping."
    fi
  else
    echo "$target already exists — skipping."
  fi
}

install_if_missing() {
  local target="$1"
  local url="$2"

  if [ ! -f "$target" ]; then
    echo "Downloading $target ..."
    mkdir -p "$(dirname "$target")"
    curl -fsSL "$url" -o "$target"
  else
    echo "$target already exists — skipping download."
  fi
}

# --- Ensure .zshrc exists early -------------------------------------

install_if_missing "$HOME/.zshrc" \
  "https://gist.githubusercontent.com/roberttaraya/ca2ad3a47f0bed3b0d29/raw/33e80a8e452959ac40f16228c680beab79d36956/.zshrc"

# --- Xcode Command Line Tools ---------------------------------------

if ! xcode-select -p >/dev/null 2>&1 ; then
  xcode-select --install
fi

# --- Homebrew Installation ------------------------------------------

if ! command -v brew >/dev/null 2>&1 ; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
else
  if [ -x /opt/homebrew/bin/brew ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi
fi

# Add brew shellenv line to .zshrc if missing
BREW_SHELLENV='eval "$(/opt/homebrew/bin/brew shellenv)"'
grep -qxF "$BREW_SHELLENV" "$HOME/.zshrc" || echo "$BREW_SHELLENV" >> "$HOME/.zshrc"

brew update
brew upgrade
brew cleanup

# --- Brew Bundle -----------------------------------------------------

if [ -f "$BREWFILE_PATH" ]; then
  echo "Using Brewfile at $BREWFILE_PATH"
  brew bundle --file="$BREWFILE_PATH"
else
  echo "No Brewfile found at $BREWFILE_PATH — skipping Brewfile installation."
fi

# --- rbenv Setup -----------------------------------------------------

if command -v rbenv >/dev/null 2>&1 ; then
  RBENV_INIT='eval "$(rbenv init - zsh)"'
  grep -qxF "$RBENV_INIT" "$HOME/.zshrc" || echo "$RBENV_INIT" >> "$HOME/.zshrc"
fi

# --- nvm Setup -------------------------------------------------------

if brew list nvm >/dev/null 2>&1 ; then
  NVM_PREFIX="$(brew --prefix nvm)"
  NVM_DIR_LINE='export NVM_DIR="$HOME/.nvm"'
  NVM_SRC_LINE="[ -s \"$NVM_PREFIX/nvm.sh\" ] && \. \"$NVM_PREFIX/nvm.sh\""

  grep -qxF "$NVM_DIR_LINE" "$HOME/.zshrc" || echo "$NVM_DIR_LINE" >> "$HOME/.zshrc"
  grep -qxF "$NVM_SRC_LINE" "$HOME/.zshrc" || echo "$NVM_SRC_LINE" >> "$HOME/.zshrc"
fi

# --- Start Services --------------------------------------------------

brew services start postgresql || true
brew services start redis || true

# --- Launch Docker Once ---------------------------------------------

open -ga Docker || true

# --- Install Dotfiles / Documents -----------------------------------

copy_if_missing "$SCRIPT_DIR/.gitconfig" "$HOME/.gitconfig"
copy_if_missing "$SCRIPT_DIR/.gitignore_global" "$HOME/.gitignore_global"

# --- Avatar (local repo copy) ---------------------------------------

copy_if_missing "$SCRIPT_DIR/avatar.jpg" \
  "$HOME/Documents/avatar.jpg"

# --- VS Code Settings & Keybindings (Local repo copy) ---------------

copy_if_missing "$VSCODE_REPO_DIR/settings.json" \
  "$VSCODE_USER_DIR/settings.json"

copy_if_missing "$VSCODE_REPO_DIR/keybindings.json" \
  "$VSCODE_USER_DIR/keybindings.json"

# --- macOS Settings --------------------------------------------------

echo "Configuring macOS defaults..."

# Trackpad: tap to click
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Mission Control: don't automatically rearrange Spaces
defaults write com.apple.dock mru-spaces -bool false

# Dock: auto-hide and hide recent applications
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock show-recents -bool false

# Screenshots: location and file type (JPG, like your previous setup)
mkdir -p "$HOME/Documents/Screenshots"
defaults write com.apple.screencapture location "$HOME/Documents/Screenshots"
defaults write com.apple.screencapture type -string "jpg"

# Restart affected services to apply settings
killall Dock Finder SystemUIServer 2>/dev/null || true

echo
echo "✅ Laptop setup complete."
echo "   Open a NEW terminal window so brew/rbenv/nvm shellenv takes effect."
